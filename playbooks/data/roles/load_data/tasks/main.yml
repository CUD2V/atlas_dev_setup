---

- name: create sql dir
  file:
    dest: "{{ download_dir }}/ohdsi/sql"
    state: directory

- name: create link_data.sql on remote
  template: src={{item.src}} dest={{item.dest}}
  with_items:
    - src: "{{ role_path }}/files/link_data.j2"
      dest: "{{ download_dir }}/ohdsi/sql/link_data.sql"

- name: "find all datafiles in {{ download_dir }}/{{ dataset }}"
  find:
    paths: "{{ download_dir }}/{{ dataset }}"
    patterns: "*.csv"
  register: data

- name: build sql COPY commands based on files in data dir
  template:
    src: "{{ role_path }}/files/load_data.j2"
    dest: "{{ download_dir }}/ohdsi/sql/load_data.sql"

- name: clone cdm repo
  git:
    repo: https://github.com/OHDSI/CommonDataModel.git
    dest: "{{ download_dir }}/ohdsi/common_data_model"
    version: v5.2.2

- name: find files sql files in cdm repo
  find:
    paths: "{{ download_dir }}/ohdsi/common_data_model/PostgreSQL/"
    patterns: "*.sql"
    recurse: yes
  register: files_matched_subdirectory

- name: copy cdm sql to shared repo
  copy:
    src: "{{ item.path }}"
    dest: "{{ download_dir }}/ohdsi/sql/"
    remote_src: yes
  with_items:
    - "{{ files_matched_subdirectory.files }}"


## TODO these are not idempotent right now. rerunning causes issues
- name: create synpuf schema
  command: psql ohdsi -c "CREATE SCHEMA IF NOT EXISTS {{ dataset }};"
  become: true
  become_user: postgres

- name: OMOP DDL
  command: psql ohdsi -f "{{download_dir}}/ohdsi/sql/OMOP CDM ddl - PostgreSQL.sql"
  become: true
  become_user: postgres
  environment:
    PGOPTIONS: --search_path={{ dataset }}

- name: load data
  command: psql ohdsi -f "{{download_dir}}/ohdsi/sql/load_data.sql"
  become: true
  become_user: postgres
  environment:
    PGOPTIONS: --search_path={{ dataset }}

- name: OMOP CDM constraints
  command: psql ohdsi -f "{{download_dir}}/ohdsi/sql/OMOP CDM constraints - PostgreSQL.sql"
  become: true
  become_user: postgres
  environment:
    PGOPTIONS: --search_path={{ dataset }}

- name: OMOP CDM indexes
  command: psql ohdsi -f "{{download_dir}}/ohdsi/sql/OMOP CDM indexes required - PostgreSQL.sql"
  become: true
  become_user: postgres
  environment:
    PGOPTIONS: --search_path={{ dataset }}

- name: Link tables to data
  command: psql ohdsi -f "{{download_dir}}/ohdsi/sql/link_data.sql"
  become: true
  become_user: postgres
  environment:
    PGOPTIONS: --search_path={{ dataset }}
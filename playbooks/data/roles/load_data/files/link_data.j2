{% set db_host = hostvars[groups['db'][0]].inventory_hostname %}
ALTER SCHEMA {{ dataset }}
  OWNER TO ohdsi_admin;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA {{ dataset }} TO ohdsi_admin;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA {{ dataset }} TO ohdsi_admin;

INSERT INTO webapi.source (source_id, source_name, source_key, source_connection, source_dialect)
VALUES (1,
        '{{ ds_name }}',
        '{{ dataset }}',
        'jdbc:postgresql://{{db_host}}:{{db_port}}/{{db_name}}?user={{admin_user}}&password={{admin_user_password}}',
        'postgresql')
ON CONFLICT (source_id) DO UPDATE
  SET source_name     = EXCLUDED.source_name,
    source_key        = EXCLUDED.source_key,
    source_connection = EXCLUDED.source_connection;

INSERT INTO webapi.source_daimon (source_daimon_id, source_id, daimon_type, table_qualifier, priority)
VALUES (1, 1, 0, '{{ dataset }}', 2),
       (2, 1, 1, '{{ dataset }}', 2),
       (3, 1, 2, 'webapi', 2),
       (4, 1, 3, 'webapi', 2)
ON CONFLICT (source_daimon_id) DO UPDATE
  SET source_id = EXCLUDED.source_id,
    daimon_type = EXCLUDED.daimon_type,
    table_qualifier = EXCLUDED.table_qualifier,
    priority = EXCLUDED.priority;

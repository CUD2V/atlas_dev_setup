---

- name: "find all vocabulary files in {{ data_download_dir }}/vocabulary"
  find:
    paths: "{{ data_download_dir }}/vocabulary"
    patterns: "*.csv"
  register: vocabulary

- name: build sql COPY commands based on files in vocab dir
  template:
    src: "{{ role_path }}/files/load.j2"
    dest: "{{ data_download_dir }}/ohdsi/sql/load_{{ item.name }}.sql"
  with_items:
  - { name: vocabulary, files: "{{ vocabulary.files }}", directory: "{{ data_download_dir }}/vocabulary", arguments: DELIMITER E'\t' CSV HEADER QUOTE E'\b'}

- name: create {{ data_dataset }} schema
  include_role:
    name: cdm
    tasks_from: create_schema
  vars:
    schema: vocabulary

## sql commands are not idempotent. Rerunning causes issues
## getting around this by creating a log file after sql runs,
## so manually have to remove that file if want to rerun.
- name: load vocabulary
  shell: psql ohdsi -f "{{ item }}"
  become: true
  become_user: postgres
  args:
    chdir: "{{data_download_dir}}/ohdsi/sql"
    creates: vocab_load_run.log
  with_items:
  - OMOP CDM ddl - PostgreSQL.sql
  - load_vocabulary.sql
  - OMOP CDM constraints - PostgreSQL.sql
  - OMOP CDM indexes required - PostgreSQL.sql
  register: vocab
  environment:
    PGOPTIONS: --search_path=vocabulary

- name: "create vocab_load_run.txt"
  copy:
    content: "{{ vocab }}"
    dest: "{{data_download_dir}}/ohdsi/sql/vocab_load_run.log"
    force: no

- name: "grant permissions on vocabulary schema"
  include_role:
    name: cdm
    tasks_from: grant_permissions
  vars:
    schema: vocabulary
